<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatib le" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />
        <link rel="stylesheet" href="./lib/layui/css/layui.css" />
        <link rel="stylesheet" href="./css/runnet_common.css" />
        <link rel="stylesheet" href="./css/runnet_page.css" />
        <title>专家领域设置</title>
        <style>
            #tree-wrap ul {
                padding-left: 40px;
            }
            #tree-wrap li {
                line-height: 38px;
            }
            #tree-wrap li i {
                cursor: pointer;
                padding-left: 10px;
            }
        </style>
    </head>

    <body>
        <div class="headDiv"></div>
        <div class="searchDiv"></div>

        <div class="runnet_main_body">
            <div class="wrap p-t-lg flex">
                <div id="my_space_nav" class="m-r-md" style="width: 200px"></div>
                <div id="my_space_content" style="width: 1000px">
                    <a onclick="showAddForm(1)" class="layui-btn layui-btn-sm">新增</a>
                    <ul id="tree-wrap"></ul>
                </div>
            </div>
        </div>
    </body>
</html>
<script src="lib/layui/layui.all.js"></script>
<script src="lib/jquery.js"></script>
<script src="js/base.js"></script>

<script>
    $('.headDiv').load('./templates/header.html')
    $('.searchDiv').load('./templates/search.html')
    $('#my_space_nav').load('templates/my_space_nav.html')
    var treeLists = []

    $(function () {
        init()
        $('#tree-wrap').on('click', '.layui-icon-addition', function (e) {
            showAddForm()
        })
        $('#tree-wrap').on('click', '.layui-icon-edit', function (e) {
            layer.prompt(
                {
                    title: '编辑',
                    value: $(e.target).parent().find('span').html(),
                },
                function (val, index) {
                    if (!val) return false
                    var submitForm = {
                        id: $(e.target).parent().attr('id'),
                        title: val,
                    }
                    updateFun(submitForm)
                    layer.close(index)
                }
            )
        })
        $('#tree-wrap').on('click', '.layui-icon-delete', function (e) {
            layer.confirm(
                '你确定要删除吗？',
                {
                    title: '提示',
                },
                function () {
                    delFun($(e.target).parent().attr('id'))
                }
            )
        })
    })
    function init() {
        $.get(baseUrl + '/entryField/queryEntryFieldList', function (res) {
            treeLists = res.data
            renderTree(treeLists)
        })
    }
    function renderTree(data) {
        for (var i = 0; i < data.length; i++) {
            var item = data[i]
            var parentId = item.parentId
            if (parentId) {
                if (item.children && item.children.length > 0) {
                    $('#' + parentId).append('<ul><li id=' + item.id + '><span>' + item.title + '</span>' + '<i class="layui-icon layui-icon-addition"></i>' + '<i class="layui-icon layui-icon-edit"></i>' + '<i class="layui-icon layui-icon-delete"></i>' + '</li></ul>')
                } else {
                    $('#' + parentId).append('<ul><li id=' + item.id + '><span>' + item.title + '</span>' + '<i class="layui-icon layui-icon-edit"></i>' + '<i class="layui-icon layui-icon-delete"></i>' + '</li></ul>')
                }
            } else {
                $('#tree-wrap').append('<li id=' + item.id + '><span>' + item.title + '</span>' + '<i class="layui-icon layui-icon-addition"></i>' + '<i class="layui-icon layui-icon-edit"></i>' + '<i class="layui-icon layui-icon-delete"></i>' + '</li>')
            }
            if (item.children && item.children.length > 0) {
                renderTree(item.children)
            }
        }
    }
    function showAddForm(level) {
        layer.prompt(
            {
                title: '新增',
                value: '',
            },
            function (val, index) {
                if (!val) return false
                var submitForm = {
                    parentId: level == 1 ? '' : $(e.target).parent().attr('id'),
                    title: val,
                }
                addFun(submitForm)
                layer.close(index)
            }
        )
    }
    function addFun(v) {
        $.ajax({
            type: 'post',
            url: baseUrl + '/entryField/saveentryField',
            contentType: 'application/json;charset=UTF-8',
            data: JSON.stringify(v),
            success: function (res) {
                if (res.code == 200) {
                    $('#tree-wrap').empty()
                    init()
                    layer.msg('新增成功')
                } else {
                    layer.msg(res.message)
                }
            },
        })
    }
    function updateFun(v) {
        $.ajax({
            type: 'post',
            url: baseUrl + '/entryField/updateEntryFieldById',
            contentType: 'application/json;charset=UTF-8',
            data: JSON.stringify(v),
            success: function (res) {
                if (res.code == 200) {
                    $('#tree-wrap').empty()
                    init()
                    layer.msg('修改成功')
                } else {
                    layer.msg(res.message)
                }
            },
        })
    }
    function delFun(v) {
        $.get(baseUrl + '/entryField/delentryField?id=' + v, function (res) {
            if (res.code == 200) {
                $('#tree-wrap').empty()
                init()
                layer.msg('删除成功')
            } else {
                layer.msg(res.message)
            }
        })
    }
</script>
