<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatib le" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />
        <link rel="stylesheet" type="text/css" href="/rsp-group-innovation/static/lib/layui/css/layui.css" />
        <link rel="stylesheet" type="text/css" href="/rsp-group-innovation/static/css/common.css" />
        <!-- 导入自己的样式表 -->
        <link rel="stylesheet" href="css/runnet_common.css" />
        <link rel="stylesheet" href="css/runnet_page.css" />
        <title>通知公告</title>
        <style>
            .notify-content {
                border-top: 1px solid #dedede;
            }
            .notify-content p {
                line-height: 28px;
            }
            .attachments li {
                margin-bottom: 8px;
            }
            .message_form .layui-form-label {
                width: 100px;
                text-align: left;
            }
            .message_form .layui-input-block {
                margin-left: 100px;
            }
            .msg-title {
                border-top: 1px dotted #2a6be3;
            }
            .notify-lists .header {
                border-bottom: 1px dotted #2a6be3;
                height: 50px;
                line-height: 50px;
                padding: 0 20px;
            }
            #notifyContent img {
                width: 100%;
            }
        </style>
    </head>

    <body>
        <div id="headDiv"></div>
        <div id="searchDiv"></div>

        <div class="runnet_main_body">
            <div class="wrap">
                <div class="runnut_head">
                    <span class="borderl"></span>
                    <span class="layui-breadcrumb">
                        <a href="index.html">首页</a>
                        <a href="runnet_crowdCreate.html">众创平台</a>
                        <a href="notifyList.html">通知公告</a>
                        <a><cite id="curTitle">公告详情</cite></a>
                    </span>
                </div>
                <div class="layui-row m-t-lg">
                    <div class="layui-col-md9">
                        <div class="block p-md overflow-hidden m-r-md">
                            <div id="notifyContent">
                                <iframe id="Iframe" frameborder="0" scrolling="no" style="border: 0px"></iframe>
                            </div>
                            <div class="overflow-hidden">
                                <div class="float-left">附件：</div>
                                <ul class="attachments float-left">
                                    暂无
                                </ul>
                                <div class="activity-rigister-wrap float-right">
                                    <a class="layui-btn" onclick="signUp()">点击报名</a>
                                </div>
                            </div>
                            <div class="m-t-lg msg-title p-t-lg">
                                <div class="nextNotice">上一篇：</div>
                                <div class="prevNotice">下一篇：</div>
                            </div>

                            <div class="font-15 font-bold m-t-lg">在线留言</div>
                            <form class="layui-form m-t-md message_form" action="" lay-filter="message_form">
                                <div class="layui-form-item">
                                    <label class="layui-form-label required">用户名</label>
                                    <div class="layui-input-block">
                                        <input
                                            type="text"
                                            name="name"
                                            lay-verify="required"
                                            autocomplete="off"
                                            placeholder="请输入用户名"
                                            class="layui-input"
                                        />
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label required">邮箱</label>
                                    <div class="layui-input-block">
                                        <input
                                            type="text"
                                            name="email"
                                            lay-verify="required|email"
                                            autocomplete="off"
                                            placeholder="请输入邮箱"
                                            class="layui-input"
                                        />
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label required">电话</label>
                                    <div class="layui-input-block">
                                        <input
                                            type="text"
                                            name="phone"
                                            lay-verify="required|phone"
                                            autocomplete="off"
                                            placeholder="请输入电话"
                                            class="layui-input"
                                        />
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label required">留言内容</label>
                                    <div class="layui-input-block">
                                        <textarea placeholder="请输入内容" name="content" lay-verify="required" class="layui-textarea"></textarea>
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <div class="layui-input-block">
                                        <a class="layui-btn" lay-submit lay-filter="submit_message">提交留言</a>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="layui-col-md3 notify-lists">
                        <div class="block">
                            <div class="overflow-hidden header">
                                <span class="float-left color-theme">通知公告</span>
                                <a href="notifyList.html" class="float-right">更多>></a>
                            </div>
                            <script id="notify_demo" type="text/html">
                                {{# layui.each(d, function(index, item){ }}
                                <li class="text-ellipsis-1">
                                    <i></i>
                                    <a onclick="toNotifyDetail(this)" id="{{item.id}}" class="link-hover">{{item.title}}</a>
                                </li>
                                {{# }); }}
                            </script>
                            <ul id="notify-wrap" class="runnet_lists p-md"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="signUpForm" style="display: none">
            <form class="layui-form m-t-md notyfy_form" action="" lay-filter="activity_register_form">
                <div class="p-lg">
                    <input type="checkbox" name="same" lay-skin="primary" />
                    我已阅读并同意<a class="color-theme">《活动性用户注册协议》</a>
                </div>
            </form>
        </div>
    </body>
</html>
<script type="text/javascript" src="/rsp-group-innovation/static/lib/jquery.js"></script>
<script type="text/javascript" src="/rsp-group-innovation/static/js/common.js"></script>
<script type="text/javascript" src="/rsp-group-innovation/static/lib/layui/layui.all.js"></script>
<script src="js/base.js"></script>
<script>
    var notifyLists = [
        {
            memo: '科技部办公厅关于印发《科技部 落实国家科技计划管理监督 主体责任实施方案》的通知',
            name: '2012-02-12',
        },
        {
            memo: '科技部 中央军委科学技术委员会关于印发《“十三五”科技军民融合发展专项规划》的通知',
            name: '2012-02-12',
        },
    ]
    var notifyId = sessionStorage.getItem('notifyId'),
        notifyDetail = {}
    layui.use(['laytpl', 'form'], function () {
        var laytpl = layui.laytpl
        var form = layui.form

        var notifyTpl = notify_demo.innerHTML
        var notifyView = document.getElementById('notify-wrap')

        $.get(baseUrl + '/notice/noticeText?noticeId=' + notifyId, function (res) {
            if (res.code === 200) {
                notifyDetail = res.data
                if (notifyDetail.pdfToPngList && notifyDetail.pdfToPngList.length) {
                    for (var i = 0; i < notifyDetail.pdfToPngList.length; i++) {
                        $('#notifyContent').append('<img src="' + baseUrl + '/' + notifyDetail.pdfToPngList[i] + '"/>')
                    }
                } else {
                    var iframe = document.getElementById('Iframe')
                    iframe.style.width = '100%'
                    iframe.src = baseUrl + '/' + res.data.wordToHtml
                    iframe.onload = function () {
                        var iframeWin = iframe.contentWindow || iframe.contentDocument.parentWindow
                        if (iframeWin.document.body) {
                            iframe.height = iframeWin.document.body.scrollHeight
                        }
                    }
                }
                setAttachement()
            }
        })
        $.ajax({
            type: 'post',
            url: baseUrl + '/notice/pageList',
            contentType: 'application/json;charset=UTF-8',
            data: JSON.stringify({ page: 1, limit: 10, state: 1 }),
            success: function (res) {
                if (res.code == 200) {
                    datagrid = res.data
                    laytpl(notifyTpl).render(res.data.data, function (html) {
                        notifyView.innerHTML = html
                    })
                }
            },
        })
        form.on('submit(submit_message)', function (data) {
            $.post({
                url: baseUrl + '/message/saveMessage',
                contentType: 'application/json;charset=UTF-8',
                data: JSON.stringify(data.field),
                success: function (res) {
                    if (res.code === 200) {
                        layer.msg('留言成功')
                        form.val('message_form', {
                            name: '', // 'name': 'value'
                            email: '',
                            phone: '',
                            content: '',
                        })
                    }
                },
            })
        })
    })
    function setAttachement() {
        var files = notifyDetail.enclosures || []
        if (files.length) {
            for (var i = 0; i < files.length; i++) {
                $('.attachments').append(
                    '<li><a class="cursor-pointer color-theme" href="' + imageUrl + files[i].url + '">' + files[i].name + '</a></li>'
                )
            }
        }
        if (Number(notifyDetail.isEnter !== 1)) {
            $('.activity-rigister-wrap').hide()
        }
        if (notifyDetail.nextTitle && notifyDetail.nextId) {
            $('.nextNotice').append(
                '<a class="link-hover " id="' + notifyDetail.nextId + '" onclick="toNotifyDetail(this)" >' + notifyDetail.nextTitle + '</a>'
            )
        }
        if (notifyDetail.lastTitle && notifyDetail.lastId) {
            $('.prevNotice').append(
                '<a class="link-hover " id="' + notifyDetail.lastId + '" onclick="toNotifyDetail(this)" >' + notifyDetail.lastTitle + '</a>'
            )
        }
    }
    function signUp() {
        var d1 = new Date(notifyDetail.submitDate),
            d2 = new Date()
        if (d2 > d1) {
            return layer.msg('活动已结束')
        }
        if (!sessionStorage.getItem('token')) {
            return layer.msg('请先登录')
        }
        layer.open({
            type: 1,
            title: '提示',
            content: $('#signUpForm'),
            scrollbar: false,
            btn: ['立即报名', '取消'],
            yes: function (index) {
                var check = $('input[name="same"]').prop('checked')
                if (!check) {
                    return layer.msg('请先阅读并同意活动性用户注册协议', { offset: '100px' })
                }
                $.ajax({
                    type: 'post',
                    url: baseUrl + '/activeUser/saveOrEditActiveUser',
                    data: JSON.stringify({
                        name: sessionStorage.getItem('token'),
                        provinceId: 111,
                        province: '四川省',
                        noticeId: notifyDetail.id,
                    }),
                    contentType: 'application/json;charset=UTF-8',
                    success: function (res) {
                        if (res.code === 200) {
                            sessionStorage.setItem('workFormId', '')
                            window.location.href = 'workForm.html'
                            layer.msg('报名成功')
                            layer.close(index)
                        }
                    },
                })
            },
        })
        if (Number) {
        }
    }
    function toNotifyDetail(target) {
        sessionStorage.setItem('notifyId', $(target).attr('id'))
        window.location.href = 'notifyDetail.html'
    }
</script>
