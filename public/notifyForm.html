<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatib le" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />
        <link rel="stylesheet" href="lib/layui/css/layui.css" />
        <link rel="stylesheet" href="css/font/iconfont.css" />
        <link rel="stylesheet" href="css/runnet_common.css" />
        <link rel="stylesheet" href="css/runnet_page.css" />
        <title>注册专家</title>
        <style lang="">
            .notyfy_form .layui-form-label {
                width: 120px;
            }
            .notyfy_form .layui-input-block {
                margin-left: 120px;
            }
            .attachment_list li {
                width: 500px;
                margin-bottom: 10px;
                position: relative;
            }
            .attachment_list i {
                position: absolute;
                right: 0;
            }
            .attachment_list i:hover {
                color: red;
            }
            .collection-setting,
            .prize_setting {
                display: none;
            }
        </style>
    </head>
    <body>
        <div class="headDiv"></div>
        <div class="searchDiv"></div>
        <div class="runnet_main_body">
            <div class="wrap">
                <form class="layui-form m-t-md notyfy_form" action="" lay-filter="notyfy_form">
                    <div class="font-15 font-bold p-b-md basic-setting">基本信息设置</div>
                    <div class="block p-md basic-setting">
                        <div class="layui-form-item">
                            <label class="layui-form-label required">标题</label>
                            <div class="layui-input-block">
                                <input type="text" name="title" lay-verify="required" placeholder="" class="layui-input" />
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label required">摘要</label>
                            <div class="layui-input-block">
                                <script id="editor" type="text/plain" style="width: 1040px; height: 400px"></script>
                                <!-- <textarea placeholder="请输入内容" rows="8" name="summary" lay-verify="required" class="layui-textarea"></textarea> -->
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">类别</label>
                            <div class="layui-input-block">
                                <select name="type" lay-verify="" lay-filter="type">
                                    <option value="0">短视频大赛</option>
                                    <option value="1">好新闻评选</option>
                                    <option value="2">观摩交流活动</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">标签</label>
                            <div class="layui-input-block">
                                <input type="text" name="tag" lay-verify="" placeholder="" class="layui-input" />
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">活动简称</label>
                            <div class="layui-input-block">
                                <input type="text" name="shortName" lay-verify="" placeholder="" class="layui-input" />
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">奖项类别</label>
                            <div class="layui-input-block">
                                <select id="awordType" lay-verify="">
                                    <option value="0">报刊类</option>
                                    <option value="1">网络类</option>
                                    <option value="2">新媒体融合类</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">导入</label>
                            <div class="layui-input-block">
                                <a class="layui-btn layui-btn-primary" id="upload_word"><i class="layui-icon">&#xe67c;</i>上传word文档</a>
                                <div class="layui-inline word_wrap"></div>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">附件</label>
                            <div class="layui-input-block">
                                <a class="layui-btn layui-btn-primary" id="upload_attachment"><i class="layui-icon">&#xe67c;</i>上传附件</a>
                                <div class="attachment_list"></div>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">线上作品收集</label>
                            <div class="layui-input-block">
                                <input type="radio" name="isCollection" value="0" title="否" checked lay-filter="workCollection" />
                                <input type="radio" name="isCollection" value="1" title="是" lay-filter="workCollection" />
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">线上活动报名</label>
                            <div class="layui-input-block">
                                <input type="radio" name="isEnter" value="0" title="否" checked lay-filter="activityRegistration" />
                                <input type="radio" name="isEnter" value="1" title="是" id="isEnter_true" lay-filter="activityRegistration" />
                            </div>
                        </div>
                    </div>
                    <div class="font-15 font-bold p-b-md collection-setting">线上作品收集设置</div>
                    <div class="block collection-setting p-md">
                        <div class="layui-form-item">
                            <label class="layui-form-label">作品信息</label>
                            <div class="layui-input-block"></div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">提交期限</label>
                            <div class="layui-input-block">
                                <input
                                    type="text"
                                    name="birthDay"
                                    id="birth_day"
                                    lay-verify=""
                                    placeholder=""
                                    autocomplete="off"
                                    class="layui-input"
                                />
                            </div>
                        </div>
                        <div class="prize_setting">
                            <div class="layui-form-item">
                                <label class="layui-form-label">奖项设定</label>
                                <div class="layui-input-block"></div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">专家反馈模式</label>
                                <div class="layui-input-block">
                                    <!-- <input type="radio" name="distMethod" value="0" title="作品打分" checked />
                                    <input type="radio" name="distMethod" value="1" title="作品排序" />
                                    <input type="radio" name="distMethod" value="2" title="投票" /> -->
                                </div>
                                <div class="layui-input-block">
                                    <!-- <input type="radio" name="distMethod" value="0" title="去最高分" checked />
                                    <input type="radio" name="distMethod" value="1" title="不去最高分" /> -->
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">作品派发方式</label>
                                <div class="layui-input-block">
                                    <input type="radio" name="distMethod" value="0" title="指定派发" checked />
                                    <input type="radio" name="distMethod" value="1" title="随机派发" />
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">分配工作人员</label>
                                <div class="layui-input-block"></div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">指派终审专家</label>
                                <div class="layui-input-block">
                                    组员
                                    <div class="layui-inline" id="expert_members" style="width: 200px"></div>
                                    组长
                                    <div class="layui-inline" style="width: 200px">
                                        <select name="" id="expert_leader"></select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">线上投票</label>
                            <div class="layui-input-block">
                                <input type="radio" name="vote" value="0" title="否" checked lay-filter="vote" />
                                <input type="radio" name="vote" value="1" title="是" lay-filter="vote" />
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">投票环节</label>
                            <div class="layui-input-block">
                                <input type="radio" name="voteLinks" value="0" title="复审" checked lay-filter="vote" />
                                <input type="radio" name="voteLinks" value="1" title="终审" lay-filter="vote" />
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label"></label>
                            <div class="layui-input-block">
                                专家评分平均分 *
                                <div class="layui-inline">
                                    <input type="text" style="width: 100px" name="expertWeight" class="layui-input" />
                                </div>
                                + 网络投票数 / 最高得票数 *
                                <div class="layui-inline">
                                    <input type="text" name="voteWeight" style="width: 100px" class="layui-input" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item m-t-lg p-l-md">
                        <div class="layui-input-block">
                            <a lay-submit class="layui-btn" lay-filter="release">发布</a>
                            <a lay-submit class="layui-btn layui-btn-primary" lay-filter="prev" style="display: none">上一步</a>
                            <a lay-submit class="layui-btn layui-btn-primary" lay-filter="next" style="display: none">下一步</a>
                            <a lay-submit class="layui-btn layui-btn-primary" lay-filter="draft">存为草稿</a>
                            <a class="layui-btn layui-btn-primary" href="notifyManage.html">返回</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </body>
</html>
<script src="lib/layui/layui.all.js"></script>
<script src="lib/layui/xm-select.js"></script>
<script src="lib/jquery.js"></script>
<script src="js/base.js"></script>

<script src="lib/ueditor/ueditor.config.js"></script>
<script src="lib/ueditor/ueditor.all.min.js"></script>
<script src="lib/ueditor/lang/zh-cn/zh-cn.js"></script>

<script>
    var ue = UE.getEditor('editor')
    $('.headDiv').load('templates/header.html')
    $('.searchDiv').load('templates/search.html')
    var resFormData = {},
        enclosureParams = [],
        expertMebers = null
    $('.attachment_list').on('click', '.del-btn', function (e) {
        var oldFileName = $(e.target).attr('name')
        $(e.target).parent().remove()
        enclosureParams = enclosureParams.filter(function (i) {
            return i.name !== oldFileName
        })
    })
    $.get(baseUrl + '/expert/queryExperyList?examineStatus=2&page=1&limit=10000&expertLevel=1', function (res) {
        expertMebers.update({ data: res.data.data })
    })
    layui.use(['upload', 'laydate', 'form'], function () {
        var upload = layui.upload,
            laydate = layui.laydate,
            laydate = layui.laydate
        ;(laydate = layui.laydate), (form = layui.form)

        expertMebers = xmSelect.render({
            el: '#expert_members',
            language: 'zn',
            // layVerify: 'required',
            // layVerType: 'msg',
            prop: {
                name: 'name',
                value: 'id',
            },
            on: function (obj) {
                $('#expert_leader').empty()
                for (var i = 0; i < obj.arr.length; i++) {
                    $('#expert_leader').append('<option value="' + obj.arr[i].id + '">' + obj.arr[i].name + '</option>')
                }
                form.render('select')
            },
        })
        //执行实例
        form.on('radio(workCollection)', function (obj) {
            if (Number(obj.value) === 1) {
                $('input[name="isEnter"]').prop('checked', false)
                $('#isEnter_true').prop('checked', true)
                $('input[name="isEnter"]').prop('disabled', true)
                $('a[lay-filter="next"]').show()
                $('a[lay-filter="release"]').hide()
                $('.prize_setting').show()
            } else {
                var isEnter = form.val('notyfy_form').isEnter
                $('input[name="isEnter"]').prop('disabled', false)
                $('.prize_setting').hide()
                if (Number(isEnter) !== 1) {
                    $('a[lay-filter="next"]').hide()
                    $('a[lay-filter="release"]').show()
                }
            }
            form.render('radio')
        })
        form.on('radio(activityRegistration)', function (obj) {
            if (Number(obj.value) === 1) {
                $('a[lay-filter="next"]').show()
                $('a[lay-filter="release"]').hide()
            } else {
                $('a[lay-filter="next"]').hide()
                $('a[lay-filter="release"]').show()
            }
        })
        form.on('submit(next)', function (obj) {
            $('.collection-setting').show()
            $('.basic-setting').hide()
            $('a[lay-filter="next"]').hide()
            $('a[lay-filter="prev"]').show()
            $('a[lay-filter="release"]').show()
        })
        form.on('submit(prev)', function (obj) {
            $('.collection-setting').hide()
            $('.basic-setting').show()
            $('a[lay-filter="next"]').show()
            $('a[lay-filter="prev"]').hide()
            $('a[lay-filter="release"]').hide()
        })
        form.on('submit(draft)', function (obj) {
            submitFun(obj, 'draft')
        })
        form.on('submit(release)', function (obj) {
            submitFun(obj, 'release')
        })
        laydate.render({
            elem: '#birth_day',
            showBottom: false,
        })
        upload.render({
            elem: '#upload_word', //绑定元素
            url: baseUrl + '/upload/fileUpload', //上传接口
            accept: 'file',
            exts: 'doc|docx|pdf',
            done: function (res) {
                if (res.code != 200) {
                    layer.msg('上传失败')
                } else {
                    resFormData.fileName = res.data.oldFileName
                    resFormData.filePath = res.data.newFileName
                    $('.word_wrap').empty()
                    $('.word_wrap').append(
                        '<a class="color-theme " target="_blank" href=' + imageUrl + res.data.newFileName + '>' + res.data.oldFileName + '</a>'
                    )
                }
                //上传完毕回调
            },
            error: function () {
                layer.msg('上传失败')
            },
        })
        upload.render({
            elem: '#upload_attachment', //绑定元素
            url: baseUrl + '/upload/fileUpload', //上传接口
            accept: 'file',
            // exts: 'doc|docx|pdf',
            done: function (res) {
                if (res.code != 200) {
                    layer.msg('上传失败')
                } else {
                    var eixtFile = enclosureParams.find(function (i) {
                        return i.name === res.data.oldFileName
                    })
                    if (!eixtFile) {
                        $('.attachment_list').append(
                            '<li> <a class="color-theme " target="_blank" href=' +
                                imageUrl +
                                res.data.newFileName +
                                '>' +
                                res.data.oldFileName +
                                "</a><i class='del-btn layui-icon layui-icon-close cursor-pointer' name=" +
                                res.data.oldFileName +
                                '></i></li>'
                        )
                        enclosureParams.push({
                            name: res.data.oldFileName,
                            url: res.data.newFileName,
                        })
                    }
                }
                //上传完毕回调
            },
            error: function () {
                layer.msg('上传失败')
            },
        })
    })
    function submitFun(obj, type) {
        var formData = Object.assign(obj.field, {})
        formData.state = type === 'draft' ? 0 : 1
        formData.type = Number(formData.type)
        formData.isEnter = Number(formData.isEnter)
        formData.isCollection = Number(formData.isCollection)
        formData.enclosureParams = enclosureParams
        $.ajax({
            type: 'post',
            url: baseUrl + '/notice/saveNotice',
            data: JSON.stringify(formData),
            contentType: 'application/json;charset=UTF-8',
            success: function (res) {
                resFormData = res.data
                if (res.code == 200) {
                    layer.msg('提交成功')
                    window.location.href = 'notifyManage.html'
                } else {
                    layer.msg(res.message)
                }
            },
        })
    }
</script>
