<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatib le" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />
        <!-- 导入 layui 的样式表 -->
        <link rel="stylesheet" type="text/css" href="http://10.168.0.218:8086/rsp-group-innovation/static/css/common.css" />
        <link rel="stylesheet" type="text/css" href="http://10.168.0.218:8086/rsp-group-innovation/static/lib/layui/css/layui.css" />
        <!-- 导入自己的样式表 -->
        <link rel="stylesheet" href="./css/runnet_common.css" />
        <link rel="stylesheet" href="./css/runnet_page.css" />
        <title>我的作品</title>
        <style>
            .search_form .layui-form-label {
                width: 100px;
            }
        </style>
    </head>

    <body>
        <div id="headDiv"></div>
        <div id="searchDiv"></div>

        <div class="runnet_main_body">
            <div class="wrap p-t-lg">
                <div id="my_space_nav" class="float-left" style="width: 180px"></div>
                <div id="my_space_content" class="float-right" style="width: 1000px">
                    <form class="layui-form search_form m-b-lg" action="" lay-filter="search_form">
                        <div class="layui-form-item">
                            <label class="layui-form-label">参与活动</label>
                            <div class="layui-input-block">
                                <select class="activity_search" lay-verify="" lay-filter="activity_search" style="width: 100px"></select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">报送性质</label>
                            <div class="layui-input-block">
                                <input type="text" name="worksInfo" readonly class="layui-input worksInfo" />
                            </div>
                        </div>
                    </form>
                    <div id="tableWrap"></div>
                    <script id="workTableScript" type="text/html">
                        {{# layui.each(d, function(idx, item){ }}
                        <div class="title m-b-xs m-t-lg">{{item.name}}</div>
                        <table class="layui-hide" id="table{{idx}}" lay-filter="work_table"></table>
                        {{# }); }}
                    </script>
                    <div class="text-center m-t-lg submitWrap" style="display: none">
                        <a class="layui-btn" onclick="submitWorks()">提交作品</a>
                    </div>
                    <script type="text/html" id="person_detail_btn">
                        <a class="layui-btn layui-btn-xs" lay-event="look_detail">查看</a>
                        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
                        <a class="layui-btn layui-btn-xs" lay-event="del">删除</a>
                    </script>
                </div>
            </div>
        </div>
        <form class="layui-form m-t-md wrok_form detailForm" action="" lay-filter="work_form" style="display: none"></form>
    </body>
</html>
<script type="text/javascript" src="http://10.168.0.218:8086/rsp-group-innovation/static/lib/jquery.js"></script>
<script type="text/javascript" src="http://10.168.0.218:8086/rsp-group-innovation/static/js/common.js"></script>
<script type="text/javascript" src="http://10.168.0.218:8086/rsp-group-innovation/static/lib/layui/layui.all.js"></script>
<script src="js/base.js"></script>
<script>
    $('#my_space_nav').load('templates/my_space_nav.html')
    var userId = sessionStorage.getItem('token'),
        formatWorks = [],
        workDetail = {}

    // state //活动状态 0草稿 1提交  2初审 3复审 4终审
    layui.use(['table', 'form', 'laytpl'], function () {
        form = layui.form
        var table = layui.table,
            laytpl = layui.laytpl

        var tpl = workTableScript.innerHTML,
            view = document.getElementById('tableWrap')

        // 获取当前登录用户所参加的所有活动
        $.get(baseUrl + '/notice/findListByUserId?activeUserId=' + userId, function (res) {
            if (res.code === 200 && res.data) {
                for (var i = 0; i < res.data.length; i++) {
                    $('.activity_search').append('<option value="' + res.data[i].id + '">' + res.data[i].shortName + '</option>')
                }
                form.render('select')
                if (res.data.length > 0) {
                    getAllWorks(res.data[0].id)
                }
            }
        })

        var getAllWorks = function (id) {
            $.ajax({
                type: 'post',
                url: baseUrl + '/works/getList',
                contentType: 'application/json;charset=UTF-8',
                data: JSON.stringify({ noticeId: id }),
                success: function (res) {
                    if (res.code === 200) {
                        renderTable(res.data)
                    }
                },
            })
        }
        renderTable = function (arr) {
            var defaultList = [
                { name: '计划单列市', value: 0, data: [] },
                { name: '气象类高校', value: 1, data: [] },
                { name: '气象局单位', value: 2, data: [] },
                { name: '团体组织（中学、社会性组织）', value: 3, data: [] },
            ]
            for (var i = 0; i < arr.length; i++) {
                for (var j = 0; j < defaultList.length; j++) {
                    if (defaultList[j].value === arr[i].worksInfo) {
                        defaultList[j].data.push(arr[i])
                    }
                }
            }
            var worksInfo = ''
            formatWorks = defaultList.filter(function (item) {
                if (item.data.length > 0) {
                    worksInfo += '+' + item.name
                }
                return item.data.length > 0
            })

            laytpl(tpl).render(formatWorks, function (html) {
                view.innerHTML = html
            })
            if (formatWorks.length > 0) {
                $('.submitWrap').show()
            }
            $('.worksInfo').val(worksInfo.substr(1))
            formatWorks.forEach(function (item, index) {
                table.render({
                    elem: '#table' + index,
                    data: item.data,
                    cols: [
                        [
                            { type: 'checkbox' },
                            { field: 'worksType', title: '作品类型' },
                            { field: 'name', title: '作品名称' },
                            { field: 'author', title: '作者姓名' },
                            { field: 'format', title: '格式' },
                            {
                                field: 'sign',
                                title: '操作',
                                width: 200,
                                toolbar: '#person_detail_btn',
                            },
                        ],
                    ],
                })
            })
        }
        table.on('tool(work_table)', function (obj) {
            var data = obj.data
            if (obj.event === 'look_detail') {
                $.get(baseUrl + '/works/detail?id=' + data.id, function (res) {
                    if (res.code === 200) {
                        workDetail = res.data
                        $('.detailForm').load('/templates/work/workDetail.html', function () {
                            layer.open({
                                type: 1,
                                title: '作品详情',
                                content: $('.detailForm'),
                                fixed: true,
                                maxmin: true,
                                area: ['1200px', '90%'],
                                cancel: function () {
                                    $('.detailForm').hide()
                                },
                            })
                        })
                    }
                })
            } else if (obj.event === 'edit') {
                sessionStorage.setItem('notifyId', data.noticeId)
                sessionStorage.setItem('workFormId', data.id)
                window.location.href = 'workForm.html'
            } else {
                if (data.state === 1) {
                    return layer.msg('作品已提交，不能删除')
                }
                layer.confirm('你确定删除该作品吗', { title: '提示' }, function () {
                    $.get(baseUrl + '/works/deleteWork?workId=' + data.id, function (res) {
                        if (res.code === 200) {
                            layer.msg('删除成功')
                            getAllWorks()
                        }
                    })
                })
            }
        })
        table.on('checkbox(work_table)', function (obj, idx) {
            // obj.update({
            //     isCheked: obj.checked ? 1 : 0,
            // })
        })

        form.on('select(activity_search)', function (obj) {
            $('#tableWrap').empty()

            getAllWorks(obj.value)
        })
    })

    function updateScore(v) {
        console.log(v)
    }
    function submitWorks() {
        var ids = []
        formatWorks.forEach(function (i) {
            i.data.forEach(function (j) {
                if (j.LAY_CHECKED) {
                    ids.push(j.id)
                }
            })
        })
        if (ids.length === 0) {
            return layer.msg('请先选择要提交的作品')
        }
        $.ajax({
            type: 'post',
            url: baseUrl + '/works/submitWorks',
            contentType: 'application/json;charset=UTF-8',
            data: JSON.stringify(ids),
            success: function (res) {
                if (res.code === 200) {
                    layer.msg('作品提交成功，请耐心等待管理员审核')
                }
            },
        })
    }
    function setDefaultValue(form) {
        var worksInfo = '',
            workTheme = []

        if (workDetail.workFields) {
            workTheme = workDetail.workFields.map(function (item) {
                return item.fieldName
            })
        }
        switch (workDetail.worksInfo) {
            case 0:
                worksInfo = '计划单列市'
                break
            case 1:
                worksInfo = '气象类高校'
                break
            case 2:
                worksInfo = '气象局单位'
                break
            case 3:
                worksInfo = '团体组织（中学、社会性组织）'
                break
        }
        form.val('work_form', {
            shortName: workDetail.shortName,
            worksType: workDetail.worksType,
            name: workDetail.name,
            author: workDetail.author,
            worksInfo: workDetail.worksInfo,
            format: workDetail.format,
            worksInfo,
            workTheme: workTheme.join('、'),
        })
        var formParams = workDetail.worksExtends || []
        var temp = ''
        for (var i = 0; i < formParams.length; i++) {
            var el = '',
                v = formParams[i].value || ' '
            if (formParams[i].sort === 1) {
                el =
                    '<input class="layui-input item" readonly id="' +
                    (formParams[i].type || i) +
                    '" value="' +
                    v +
                    '" placeholder="' +
                    formParams[i].placeholder +
                    '"/>'
            } else if (formParams[i].sort === 2) {
                el = '<textarea class="layui-textarea item" readonly placeholder="' + formParams[i].placeholder + '">' + v + '</textarea>'
            } else if (formParams[i].sort === 0) {
                // el = '<a class="layui-btn layui-btn-primary" id="companyAttachment">上传打扫件</a>'
            }
            temp +=
                '<div class="layui-form-item" sort="' +
                formParams[i].sort +
                '">' +
                '<label class="layui-form-label">' +
                formParams[i].name +
                '</label>' +
                '<div class="layui-input-block">' +
                el +
                '</div></div>'
        }
        $('#customDefineParmWrap').append(temp)

        $('.workList').append('<a class="color-theme" target="_blank" href="' + imageUrl + workDetail.url + '">' + workDetail.filename + '</a>')
    }
</script>
